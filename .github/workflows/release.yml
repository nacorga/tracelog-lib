name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - patch
        - minor
        - major
      force_version:
        description: 'Force specific version (e.g., 1.2.3)'
        required: false
        type: string
      skip_tests:
        description: 'Skip test suite'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

  push:
    branches: [main]
    paths-ignore:
      - 'CHANGELOG.md'
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  check-release-needed:
    name: Check Release Needed
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check-release.outputs.should-release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Check if release is needed
        id: check-release
        run: |
          # Check if this is a manual trigger or if there are releasable commits
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Manual release triggered"
          else
            # Check for conventional commits that warrant a release
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [[ -z "$LAST_TAG" ]]; then
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "ğŸ‰ No previous tags, first release"
            else
              COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || echo "")
              if echo "$COMMITS" | grep -qE "^(feat|fix|perf|docs|style|refactor|test|chore|ci|build)(\(.+\))?:" || echo "$COMMITS" | grep -q "BREAKING CHANGE"; then
                echo "should-release=true" >> $GITHUB_OUTPUT
                echo "ğŸš€ Found conventional commits requiring release"
              else
                echo "should-release=false" >> $GITHUB_OUTPUT
                echo "â­ï¸ No releasable commits found"
              fi
            fi
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-release-needed
    if: needs.check-release-needed.outputs.should-release == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org/'
          scope: '@tracelog'
          cache: 'npm'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      - name: Make scripts executable
        run: chmod +x scripts/*.js

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Verify CI Status
        run: |
          echo "ğŸ” Verifying main branch passed all CI checks..."
          echo "âœ… Release triggered from validated main branch"
          echo "ğŸ“ Note: All tests were validated by CI workflow"
          echo "ğŸš€ Proceeding with release preparation"

      - name: Prepare release (update version, changelog, commit)
        run: |
          # Build release command based on inputs
          RELEASE_CMD="node scripts/release.js"

          # Add dry run flag if requested
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
          fi

          # Add version type or force version
          if [[ -n "${{ github.event.inputs.force_version }}" ]]; then
            RELEASE_CMD="$RELEASE_CMD --force-version ${{ github.event.inputs.force_version }}"
          elif [[ "${{ github.event.inputs.version_type }}" != "auto" ]]; then
            # For manual version types, we'll modify the release script to accept this
            case "${{ github.event.inputs.version_type }}" in
              "major"|"minor"|"patch")
                # We could implement a --force-bump-type flag in the release script
                echo "Manual version type: ${{ github.event.inputs.version_type }}"
                ;;
            esac
          fi

          # Add verbose flag for GitHub Actions
          RELEASE_CMD="$RELEASE_CMD --verbose"

          echo "Executing: $RELEASE_CMD"
          eval $RELEASE_CMD

      - name: Get release version
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Release version: $VERSION"

      - name: Push release commit
        if: github.event.inputs.dry_run != 'true'
        run: |
          git push origin main
          echo "âœ… Release commit pushed to main"

      - name: Create git tag
        if: github.event.inputs.dry_run != 'true'
        run: |
          git tag -a v${{ steps.get-version.outputs.version }} -m "Release v${{ steps.get-version.outputs.version }}"
          git push origin v${{ steps.get-version.outputs.version }}
          echo "âœ… Git tag v${{ steps.get-version.outputs.version }} created and pushed"

      - name: Publish to NPM
        if: github.event.inputs.dry_run != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸ“¦ Publishing to NPM..."
          npm publish
          echo "âœ… Published v${{ steps.get-version.outputs.version }} to NPM"

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "ğŸ“ Creating GitHub Release for v${VERSION}..."

          gh release create "v${VERSION}" \
            --title "Release v${VERSION}" \
            --notes "Release v${VERSION}

          For detailed changes, see [CHANGELOG.md](./CHANGELOG.md).

          ## Installation

          \`\`\`bash
          npm install @tracelog/lib@${VERSION}
          \`\`\`

          ## Documentation

          See [README.md](./README.md) for usage instructions." \
            dist/browser/tracelog.js#tracelog-${VERSION}.js

          echo "âœ… GitHub Release created for v${VERSION}"

      - name: Post-release validation
        if: github.event.inputs.dry_run != 'true'
        run: |
          # Verify the package was published
          PACKAGE_VERSION=$(npm view @tracelog/lib version)
          if [[ "$PACKAGE_VERSION" == "${{ steps.get-version.outputs.version }}" ]]; then
            echo "âœ… Package successfully published to NPM"
          else
            echo "âŒ Package version mismatch on NPM"
            exit 1
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [check-release-needed, release]
    if: always() && needs.release.result == 'success'

    steps:
      - name: Release Success Notification
        run: |
          echo "ğŸ‰ Release completed successfully!"
          echo "Version: ${{ needs.release.outputs.version }}"
          echo "ğŸ“¦ Package published to NPM"
          echo "ğŸ”— Check the release at: ${{ github.server_url }}/${{ github.repository }}/releases"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [check-release-needed, release]
    if: always() && (needs.check-release-needed.result == 'failure' || needs.release.result == 'failure')

    steps:
      - name: Release Failure Notification
        run: |
          echo "âŒ Release failed!"
          echo "ğŸ” Check the workflow logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ’¡ Note: All validations should pass in CI before attempting release"
          exit 1