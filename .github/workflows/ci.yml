name: CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org/'
          scope: '@tracelog'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-browsers-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-browsers-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Make scripts executable
        run: chmod +x scripts/*.js

      - name: Dependencies Security Check
        run: |
          echo "ğŸ” Checking dependencies for vulnerabilities..."
          npm audit --audit-level high || {
            echo "âŒ Security vulnerabilities found"
            npm audit
            exit 1
          }
          echo "âœ… No high-severity vulnerabilities found"

      - name: Code Quality Check
        run: |
          echo "ğŸ” Running code quality checks..."
          npm run check
          echo "âœ… Code quality checks passed"

      - name: Build Integrity Check
        run: |
          echo "ğŸ” Testing build integrity..."
          # Clean previous builds
          rm -rf dist || true

          # Run full build
          npm run build:all

          # Verify build outputs
          required_files=(
            "dist/esm/public-api.js"
            "dist/esm/public-api.d.ts"
            "dist/cjs/public-api.js"
            "dist/browser/tracelog.js"
          )

          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ Missing build output: $file"
              exit 1
            fi
          done

          # Check file sizes (basic sanity check)
          browser_build="dist/browser/tracelog.js"
          size_kb=$(du -k "$browser_build" | cut -f1)

          if [[ $size_kb -gt 100 ]]; then
            echo "âš ï¸ Browser build is large: ${size_kb}KB"
          fi

          echo "âœ… Build completed successfully. Browser build: ${size_kb}KB"

      - name: Run E2E Tests
        run: |
          echo "ğŸ” Running E2E tests..."
          npm run test:e2e

      - name: Upload test results (if tests fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.event.pull_request.number || 'main' }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Package Configuration Check
        run: |
          echo "ğŸ” Validating package configuration..."

          # Check required fields
          required_fields=("name" "version" "description" "main" "module" "types")
          for field in "${required_fields[@]}"; do
            if ! node -p "require('./package.json').$field" > /dev/null 2>&1; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done

          # Check exports configuration
          if ! node -p "require('./package.json').exports" > /dev/null 2>&1; then
            echo "âŒ Missing exports configuration"
            exit 1
          fi

          # Check files array
          if ! node -p "require('./package.json').files.length > 0" > /dev/null 2>&1; then
            echo "âŒ Missing or empty files array"
            exit 1
          fi

          # Validate version format
          version=$(node -p "require('./package.json').version")
          if ! echo "$version" | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$"; then
            echo "âŒ Invalid version format: $version"
            exit 1
          fi

          echo "âœ… Package configuration is valid"

      - name: Validation Summary
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ All validation checks passed!"
          echo "âœ… No security vulnerabilities"
          echo "âœ… Code quality passed"
          echo "âœ… Build integrity verified"
          echo "âœ… E2E tests passed"
          echo "âœ… Package configuration valid"
          echo ""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "âœ… Pull request is ready for merge!"
          else
            echo "ğŸš€ Main branch is healthy and ready for release!"
          fi