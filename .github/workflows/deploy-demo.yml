name: Deploy Demo to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'playground/**'
      - 'src/**'
      - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-demo:
    name: Build and Deploy Playground Demo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TraceLog library (production)
        run: |
          echo "ğŸ”¨ Building TraceLog library for production..."
          npm run build:browser
          echo "âœ… Build completed"

      - name: Copy build to playground
        run: |
          echo "ğŸ“¦ Copying tracelog.js to playground..."
          cp dist/browser/tracelog.esm.js playground/tracelog.js
          echo "âœ… Copy completed"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet playground/tracelog.js; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected in playground/tracelog.js"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Changes detected in playground/tracelog.js"
          fi

      - name: Configure Git
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit updated tracelog.js
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "ğŸ’¾ Committing updated tracelog.js..."
          git add playground/tracelog.js
          git commit -m "chore(demo): update playground tracelog.js build [skip ci]"
          echo "âœ… Changes committed"

      - name: Push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "ğŸš€ Pushing changes to main..."
          git push
          echo "âœ… Changes pushed successfully"

      - name: Deployment summary
        run: |
          echo ""
          echo "ğŸ‰ Demo deployment completed!"
          echo ""
          if [[ "${{ steps.check-changes.outputs.changed }}" == "true" ]]; then
            echo "âœ… playground/tracelog.js updated and committed"
            echo "ğŸ“¡ GitHub Pages will auto-deploy the updated demo"
          else
            echo "â„¹ï¸ No build changes detected"
            echo "ğŸ“¡ GitHub Pages already has the latest version"
          fi
          echo ""
          echo "ğŸŒ Demo URL: https://nacorga.github.io/tracelog-lib/"
          echo "ğŸ“ Source: /playground folder"
          echo ""
          echo "â„¹ï¸ Note: Configure GitHub Pages to serve from /playground folder"
          echo "   Settings â†’ Pages â†’ Source: main branch â†’ /playground folder"

  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: deploy-demo
    if: failure()

    steps:
      - name: Deployment Failure Notification
        run: |
          echo "âŒ Demo deployment failed!"
          echo "ğŸ” Check the workflow logs for details"
          exit 1
