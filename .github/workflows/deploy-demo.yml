name: Deploy Demo to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**'
      - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-demo:
    name: Build and Deploy Playground Demo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TraceLog library (production)
        run: |
          echo "ğŸ”¨ Building TraceLog library for production..."
          npm run build:browser
          echo "âœ… Build completed"

      - name: Copy build to docs
        run: |
          echo "ğŸ“¦ Copying tracelog.js to docs..."
          cp dist/browser/tracelog.esm.js docs/tracelog.js
          echo "âœ… Copy completed"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: 'chore(demo): deploy updated demo to GitHub Pages'

      - name: Deployment summary
        run: |
          echo ""
          echo "ğŸ‰ Demo deployment completed!"
          echo ""
          echo "âœ… docs/ folder deployed to gh-pages branch"
          echo "ğŸ“¡ GitHub Pages will serve from gh-pages branch"
          echo ""
          echo "ğŸŒ Demo URL: https://nacorga.github.io/tracelog-lib/"
          echo "ğŸ“ Source: gh-pages branch (auto-updated)"
          echo ""
          echo "â„¹ï¸ Note: Ensure GitHub Pages is configured:"
          echo "   Settings â†’ Pages â†’ Source: gh-pages branch â†’ /(root)"

  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: deploy-demo
    if: failure()

    steps:
      - name: Deployment Failure Notification
        run: |
          echo "âŒ Demo deployment failed!"
          echo "ğŸ” Check the workflow logs for details"
          exit 1
