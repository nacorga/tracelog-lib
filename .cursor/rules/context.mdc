---
alwaysApply: true
---

# TraceLog Library

**JavaScript library for web analytics and real-time event tracking**

## ğŸ¯ Purpose

Event tracking library that automatically captures user interactions (clicks, scrolls, navigation, web performance) and supports custom events. Features cross-tab session management, session recovery, and event sampling.

## ğŸ—ï¸ Architecture

```
src/
â”œâ”€â”€ api.ts                      # Public API (init, event, destroy)
â”œâ”€â”€ app.ts                      # Main orchestrator class managing handlers and state
â”œâ”€â”€ test-bridge.ts              # E2E testing bridge (dev mode only)
â”œâ”€â”€ handlers/                   # Event capture handlers
â”‚   â”œâ”€â”€ click.handler.ts        # Click tracking
â”‚   â”œâ”€â”€ scroll.handler.ts       # Scroll tracking
â”‚   â”œâ”€â”€ session.handler.ts      # Session management
â”‚   â”œâ”€â”€ performance.handler.ts  # Web vitals capture
â”‚   â”œâ”€â”€ error.handler.ts        # JavaScript error tracking
â”‚   â”œâ”€â”€ page-view.handler.ts    # Page navigation tracking
â”‚   â””â”€â”€ viewport.handler.ts     # Element visibility tracking
â”œâ”€â”€ managers/                   # Core business logic and state management
â”‚   â”œâ”€â”€ event.manager.ts        # Event queue and dispatching
â”‚   â”œâ”€â”€ session.manager.ts      # Session lifecycle management
â”‚   â”œâ”€â”€ storage.manager.ts      # localStorage abstraction
â”‚   â”œâ”€â”€ state.manager.ts        # Global shared state management
â”‚   â”œâ”€â”€ sender.manager.ts       # Event transmission to backend (per-integration)
â”‚   â”œâ”€â”€ consent.manager.ts      # GDPR/CCPA consent tracking
â”‚   â””â”€â”€ user.manager.ts         # User identification and tracking
â”œâ”€â”€ listeners/                  # Low-level event listener management
â”‚   â”œâ”€â”€ activity-listener-manager.ts    # User activity detection
â”‚   â”œâ”€â”€ input-listener-managers.ts      # Form input tracking
â”‚   â”œâ”€â”€ touch-listener-manager.ts       # Touch event handling
â”‚   â”œâ”€â”€ unload-listener-manager.ts      # Page unload detection
â”‚   â””â”€â”€ visibility-listener-manager.ts  # Page visibility changes
â”œâ”€â”€ integrations/               # Third-party integrations
â”œâ”€â”€ constants/                  # Configuration constants
â”œâ”€â”€ utils/                      # Utility functions and validation helpers
â”‚   â”œâ”€â”€ browser/                # Browser detection and capabilities
â”‚   â”œâ”€â”€ data/                   # Data transformation utilities
â”‚   â”œâ”€â”€ network/                # Network request helpers
â”‚   â”œâ”€â”€ security/               # Sanitization and security
â”‚   â””â”€â”€ validations/            # Input validation helpers
â””â”€â”€ types/                      # TypeScript type definitions
```

**Main flow**: `init()` â†’ Configure â†’ Activate handlers â†’ EventManager queues â†’ [Optional: SenderManager sends to backend] â†’ Emit to local listeners

## ğŸ“š Core API

| Method | Description |
|--------|-------------|
| `init(config?)` | Initialize tracking (see Configuration) |
| `event(name, metadata?)` | Track custom events |
| `on(event, callback)` | Subscribe to events (`'event'`, `'queue'`, `'consent-changed'`) |
| `off(event, callback)` | Unsubscribe from events |
| `setTransformer(hook, fn)` | Transform events before sending |
| `removeTransformer(hook)` | Remove a transformer |
| `setConsent(integration, granted)` | Grant/revoke consent for integrations |
| `hasConsent(integration)` | Check if consent granted |
| `getConsentState()` | Get consent state for all integrations |
| `isInitialized()` | Check initialization status |
| `setQaMode(enabled)` | Enable/disable QA mode |
| `destroy()` | Stop tracking and cleanup |

**Recommended Initialization Order:**
```typescript
// 1. Register listeners FIRST (before init)
tracelog.on('event', eventHandler);
tracelog.on('queue', queueHandler);

// 2. Configure transformers SECOND (if using custom backend)
tracelog.setTransformer('beforeSend', transformFn);

// 3. Initialize LAST (starts tracking immediately)
await tracelog.init({ /* config */ });

// 4. Track custom events AFTER init
tracelog.event('custom_event', { /* metadata */ });
```

## ğŸ› ï¸ Tech Stack

- **TypeScript 5.7** - Strong typing and latest features
- **Vite** - Fast build tool and bundler
- **web-vitals 4.2** - Only runtime dependency for performance metrics
- **Vitest** - Unit and integration testing framework
- **Playwright** - End-to-end testing framework
- **ESLint + Prettier** - Code linting and formatting

## ğŸ“¦ Current Version

**v1.2.0** - Client-only library with optional backend integrations, consent management, and transformers

## ğŸŒ SSR/SSG Support

Safe to import in SSR frameworks (Angular Universal, Next.js, Nuxt, SvelteKit). All methods silently no-op in Node.js environments.


## ğŸ“ Code Conventions

### Lint \& Format

```bash
npm run check      # Lint and format verification
npm run fix        # Auto-fix linting and formatting issues
```


### Naming

- Classes: `PascalCase` (e.g., `EventManager`)
- Files: `kebab-case.type.ts` (e.g., `session.manager.ts`)
- Public methods: `camelCase`
- Private methods: `camelCase` prefixed with `private`
- Constants: `UPPER_SNAKE_CASE`


### Patterns

- Managers extend `StateManager` for global state access
- Handlers are classes capturing specific DOM events
- Types declared in separate `.types.ts` files
- Utils contain pure functions grouped by domain


## ğŸš€ Common Commands

```bash
# Build commands
npm run build              # TypeScript build (both ESM and CJS)
npm run build:browser      # Browser-specific build using Vite
npm run build:all          # Complete build (ESM + CJS + browser)
npm run type-check         # TypeScript type checking
npm run ci:build           # CI-specific build

# Testing
npm run test:unit          # Unit tests (Vitest)
npm run test:integration   # Integration tests (Vitest)
npm run test:e2e           # E2E tests (Playwright)
npm run test               # All tests
npm run test:coverage      # Coverage report

# Development
npm run serve:test         # Start local test server (port 3000)
npm run docs:dev           # Start docs server

# Quality assurance
npm run lint               # Run ESLint
npm run format             # Run Prettier formatting
npm run check              # Run lint and format verification
npm run fix                # Auto-fix lint and format issues

# Release
npm run release:patch      # Patch version release
npm run release:minor      # Minor version release
npm run release:major      # Major version release
```


## ğŸ” Critical Paths

### 1. Initialization

`api.init()` â†’ `App.init()` â†’ `setState()` â†’ `initHandlers()` â†’ event listeners active

### 2. Event Tracking

DOM event occurs â†’ Handler captures â†’ `EventManager.track()` queues event â†’ `SenderManager` sends events (if backend configured)

### 3. Session Management

User activity tracked â†’ `SessionManager` syncs across tabs â†’ recovers session on failure

### 4. Data Sending

Events batched (10s or 50 events) â†’ `SenderManager` sends per-integration â†’ Automatic retry on 5xx/timeout (up to 2 retries) â†’ Persist failed events â†’ Recovery on next page

## ğŸ“Š Event Types

- `PAGE_VIEW` - Page navigation tracking
- `CLICK` - User click interactions
- `SCROLL` - Scroll depth and engagement
- `SESSION_START` / `SESSION_END` - Session boundaries
- `CUSTOM` - Business-specific events
- `WEB_VITALS` - Performance metrics (LCP, INP, CLS)
- `ERROR` - JavaScript error tracking
- `VIEWPORT_VISIBLE` - Element visibility tracking

## ğŸ”Œ Integration Modes

### Standalone Mode (Default - No Backend)
```typescript
await tracelog.init();
// Events tracked locally, emitted via on('event'), no HTTP calls
```

### TraceLog SaaS
```typescript
await tracelog.init({
  integrations: {
    tracelog: { projectId: 'your-project-id' }
  }
});
```

### Custom Backend
```typescript
await tracelog.init({
  integrations: {
    custom: { collectApiUrl: 'https://api.example.com/collect' }
  }
});
```

### Multi-Integration (TraceLog SaaS + Custom Backend)
```typescript
await tracelog.init({
  integrations: {
    tracelog: { projectId: 'your-project-id' },           // Analytics dashboard
    custom: { collectApiUrl: 'https://warehouse.com' }    // Data warehouse
  }
});

// Events sent to BOTH endpoints independently with:
// âœ… Independent error handling (4xx/5xx per integration)
// âœ… Independent retry/persistence (separate localStorage keys)
// âœ… Parallel sending (non-blocking)
// âœ… Transformers: SaaS gets original, custom gets transformed
```

## âš™ï¸ Configuration Options

```typescript
interface Config {
  // Session
  sessionTimeout?: number;              // Session duration (15min default)

  // Metadata
  globalMetadata?: Record<string, any>; // Data added to all events

  // Privacy & Consent
  sensitiveQueryParams?: string[];      // URL parameter filtering
  waitForConsent?: boolean;             // Buffer events until consent granted
  maxConsentBufferSize?: number;        // Max buffered events (500 default)

  // Client-side controls
  samplingRate?: number;                // Event sampling (0-1)
  errorSampling?: number;               // Error sampling (0-1)
  disabledEvents?: Array<'scroll' | 'web_vitals' | 'error'>; // Disable specific auto-tracked events

  // Throttling
  pageViewThrottleMs?: number;          // Page view throttle (1000ms default)
  clickThrottleMs?: number;             // Click event throttle (300ms default)
  maxSameEventPerMinute?: number;       // Event rate limiting (60 default)

  // Scroll tracking
  primaryScrollSelector?: string;       // CSS selector for primary scroll container

  // Viewport tracking
  viewport?: ViewportConfig;            // Element visibility tracking

  // Web Vitals
  webVitalsMode?: 'all' | 'needs-improvement' | 'poor';
  webVitalsThresholds?: Partial<Record<WebVitalType, number>>;

  // Integrations
  integrations?: {
    tracelog?: { projectId: string; };
    custom?: { collectApiUrl: string; allowHttp?: boolean; };
  };

  // Testing
  allowHttp?: boolean;                  // Enable HTTP for testing
}
```

## ğŸ” Consent Management

GDPR/CCPA-compliant consent with granular per-integration control:

```typescript
// Initialize with consent waiting
await tracelog.init({
  waitForConsent: true,  // Events buffered until consent granted
  integrations: {
    tracelog: { projectId: 'your-project-id' },
    custom: { collectApiUrl: 'https://api.example.com' }
  }
});

// Grant consent (flushes buffered events)
await tracelog.setConsent('all', true);

// Per-integration consent
await tracelog.setConsent('tracelog', true);
await tracelog.setConsent('custom', false);

// Check consent
if (tracelog.hasConsent('tracelog')) { /* ... */ }

// Get full state
const state = tracelog.getConsentState(); // { tracelog: true, custom: false }

// Listen to changes
tracelog.on('consent-changed', (state) => {
  console.log('Consent updated:', state);
});
```

**Key Features:**
- Event buffering until consent granted
- Retroactive send when consent granted (SESSION_START first)
- Per-integration control (tracelog, custom)
- Persistent in localStorage (365-day expiration)
- Cross-tab synchronization
- Can be set before or after `init()`

## ğŸ”„ Transformers

Transform events dynamically before sending to integrations:

```typescript
// Per-event transformation (before queueing)
tracelog.setTransformer('beforeSend', (event) => {
  if ('type' in event) {
    return {
      ...event,
      custom_event: {
        ...event.custom_event,
        metadata: {
          ...event.custom_event?.metadata,
          environment: 'production'
        }
      }
    };
  }
  return event;
});

// Batch transformation (before network send)
tracelog.setTransformer('beforeBatch', (batch) => {
  if ('events' in batch) {
    return {
      ...batch,
      global_metadata: {
        ...batch.global_metadata,
        batchSize: batch.events.length
      }
    };
  }
  return batch;
});

// Remove transformers
tracelog.removeTransformer('beforeSend');
tracelog.removeTransformer('beforeBatch');
```

**Integration Behavior:**
- **Standalone (no backend)**: Only `beforeSend` applied, `beforeBatch` NOT supported
- **Custom Backend**: Both transformers applied
- **TraceLog SaaS**: Transformers silently ignored (schema protection)
- **Multi-Integration**: SaaS gets original, custom gets transformed

**Error Handling:**
- Exceptions caught and logged
- Original event/batch used as fallback
- Returning `null` filters out event/batch

## ğŸ”„ Error Handling & Retry Strategy

**Automatic Retry for Transient Errors:**
- **Maximum Retries**: 2 additional attempts per integration (3 total)
- **Backoff Formula**: `100ms * (2 ^ attempt) + random(0-100ms)`
- **Delays**: Attempt 1â†’2: 200-300ms, Attempt 2â†’3: 400-500ms
- **Transient Errors**: 5xx, 408 Request Timeout, 429 Too Many Requests, network failures
- **Permanent Errors**: 4xx (except 408, 429) - no retries, immediate discard

**Persistence & Recovery:**
- Failed events (after exhausting retries) persist to localStorage per-integration
- Recovery happens automatically on next page load during `init()`
- Multi-tab protection (1s window prevents concurrent recovery)
- Events expire after 2 hours in localStorage
- **Optimistic Queue Removal**: Events removed if AT LEAST ONE integration succeeds

**Error Classification:**
| Status Code | Type | Retries | Persistence |
|-------------|------|---------|-------------|
| 2xx | Success | None | Cleared |
| 4xx (except 408, 429) | Permanent | None | Discarded |
| 408, 429 | Transient | Up to 2 | After exhaustion |
| 5xx | Transient | Up to 2 | After exhaustion |
| Network Error | Transient | Up to 2 | After exhaustion |

## âš ï¸ WHAT NOT TO DO

### ğŸš« Dependencies \& Build

- DONâ€™T add dependencies unless absolutely necessary; only `web-vitals` is allowed
- DONâ€™T break ESM/CJS dual compatibility; keep `exports` consistent in `package.json`
- DONâ€™T change `dist/` folder structure
- DONâ€™T commit without passing `npm run check`


### ğŸš« Security

- DONâ€™T store sensitive information in `localStorage`
- DONâ€™T send Personally Identifiable Information (PII) without proper sanitization (`sanitize.utils.ts`)
- DONâ€™T execute dynamic or unvalidated code
- DONâ€™T expose internal-only APIs in the browser build


### ğŸš« Performance

- DONâ€™T cause memory leaks; always call `cleanup()` in handlers
- DONâ€™T block the main thread; use passive event listeners
- DONâ€™T send high-frequency events without throttling
- DONâ€™T allow the event queue to grow infinitely (use `MAX_EVENTS_QUEUE_LENGTH` limit)


### ğŸš« State \& Sessions

- DONâ€™T mutate `globalState` directly; always use `StateManager.set()`
- DONâ€™T instantiate multiple `App` instances concurrently
- DONâ€™T call `init()` unless `typeof window !== 'undefined'`
- DONâ€™T ignore session recovery failures to prevent data loss


## ğŸ¯ Common Tasks

### Development

```bash
# Local development setup
npm run serve:test      # Terminal 1: start test server
npm run test:e2e        # Terminal 2: run e2e tests

# Pre-commit checks
npm run check           # Lint and format validation
npm run build:all       # Ensure build success
```


## ğŸ§ª Testing Strategy

### Unit Tests (Vitest)
- Test individual functions and classes
- 90%+ coverage for core logic required
- Location: `tests/unit/`

### Integration Tests (Vitest)
- Test component interactions
- Verify data flow between managers
- Location: `tests/integration/`

### E2E Tests (Playwright)
- Browser-based tests using `window.__traceLogBridge`
- Test server runs on `http://localhost:3000`
- Location: `tests/e2e/`

## ğŸ› Debug & QA Mode

### QA Mode (Manual Testing)
```typescript
// Activate via URL parameter
window.location.href = '?tlog_mode=qa';
// Effects:
// - Custom events logged to console (not sent to backend)
// - Strict validation (throws errors instead of silent failures)
// - Events still emitted to on('event') listeners
```

### Debug Utilities
```typescript
// Check initialization status
tracelog.isInitialized(); // boolean

// E2E Testing Bridge (dev mode only)
window.__traceLogBridge.init(config);
window.__traceLogBridge.sendCustomEvent(name, metadata);
window.__traceLogBridge.on('event', callback);
window.__traceLogBridge.on('queue', callback);
window.__traceLogBridge.getSessionData();
```


### Adding New Features

```typescript
// Steps to add new functionality

// 1. Create a new handler class under handlers/
// 2. Register the handler in App.initHandlers()
// 3. Add new types to the types/ directory
// 4. Add validation helpers if needed in utils/validations/
// 5. Write end-to-end tests under tests/
```
