# TraceLog Client Library (@tracelog/lib)

> Lightweight web analytics library for tracking user behavior. Works standalone or with optional backend integrations.

üìö **Platform Overview**: See [platform CLAUDE.md](../CLAUDE.md) for full platform architecture

---

# ‚ö†Ô∏è Critical Instructions

**READ THIS FIRST** - These override default behavior:

1. **NEVER create files** unless absolutely necessary for the task
2. **ALWAYS prefer editing** existing files to creating new ones
3. **NEVER proactively create documentation** (*.md) files unless explicitly requested
4. **ALWAYS update documentation** when making code changes
5. **NEVER edit CHANGELOG.md** - It's auto-generated by CI/CD workflows only
6. **Use `/new-feature`** for ALL new features - it's 40-50% faster and more thorough
7. **Run `/precommit`** before every commit - no exceptions
8. **Run `/compare-branch`** before merging - prevents issues from reaching main

---

# Development

## Automation Pipeline

**IMPORTANT**: This project uses a comprehensive Claude Code automation pipeline (`.claude/` folder) with:
- **6 Custom Agents** - Specialized AI assistants for different tasks
- **7 Slash Commands** - Quick commands for common operations
- **4 Development Hooks** - Automated validations during development

üìñ **Full Pipeline Documentation**: [.claude/README.md](./.claude/README.md)

## Agent Usage Policy

**IMPORTANT**: Always use the appropriate specialized agent for the task:

1. **`feature-orchestrator`** ‚≠ê USE FOR ALL NEW FEATURES
   - **Command**: `/new-feature [description]`
   - **When**: Starting ANY new feature (handlers, managers, integrations)
   - **Benefit**: 40-50% faster, automated quality validation

2. **`clean-code-architect`**
   - **When**: General code improvements, refactoring, bug fixes

3. **`test-guardian`**
   - **Command**: `/coverage`
   - **When**: After adding features or modifying core code
   - **Enforces**: 90%+ coverage for handlers/managers/utils

4. **`type-safety-enforcer`**
   - **Command**: Part of `/precommit`
   - **When**: Before committing code
   - **Enforces**: Zero TypeScript errors with strict mode

5. **`memory-leak-detector`**
   - **When**: Creating/modifying event handlers or managers
   - **Checks**: Event listener cleanup, timer management

6. **`security-privacy-advisor`**
   - **Command**: `/security-audit`
   - **When**: Before production release
   - **Validates**: GDPR compliance, PII protection

## Technical Requirements

**MUST** follow these requirements:
- TypeScript 5.7 strict mode enforced - **ZERO type errors accepted**
- Single runtime dependency: `web-vitals` - No exceptions
- Dual ESM/CJS support required - Both must build successfully
- **Documentation Updates**: When making code changes, **YOU MUST** update relevant *.md files (except CHANGELOG.md)
- **Documentation Style**: Describe CURRENT STATE only. **NEVER** reference versions or use phrases like "New in vX.X.X", "Optimized", "75% reduction"

## Development Hooks (Auto-Run)

**IMPORTANT**: These hooks run automatically:

1. **PreToolUse (Edit/Write)** - Runs `npm run type-check` before edits ‚Üí **BLOCKS** if errors exist
2. **PostToolUse (Edit)** - Runs related tests after edits ‚Üí Immediate feedback
3. **SessionStart** - Shows git status, health check, available commands on start
4. **UserPromptSubmit** - Warns about unnecessary file creation

üìñ **Hook Details**: [.claude/README.md#-development-hooks](./.claude/README.md#-development-hooks)

---

# Acceptance Criteria

**IMPORTANT**: All changes **MUST** meet these before commit - **BLOCKS COMMIT** if failing:

- ‚úÖ **Zero build errors** ‚Üí `npm run build:all`
- ‚úÖ **Zero type errors** ‚Üí `npm run type-check`
- ‚úÖ **Zero lint errors** ‚Üí `npm run lint` (warnings OK)
- ‚úÖ **100% test pass rate** ‚Üí `npm run test`
- ‚úÖ **90%+ core logic coverage** ‚Üí `npm run test:coverage`

üí° **Quick validation**: Run `/precommit` (validates all automatically)

---

# Commands Reference

## üéØ Slash Commands (Custom)

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `/new-feature [desc]` | ‚≠ê **Interactive feature development** | Starting ANY new feature |
| `/precommit` | Full acceptance criteria validation | Before every commit |
| `/compare-branch [branch]` | Pre-merge audit & quality check | Before merging branches |
| `/coverage` | Test coverage analysis | After code changes |
| `/security-audit` | GDPR/privacy compliance scan | Before production |
| `/perf` | Bundle size & performance check | After dependencies/features |
| `/fix` | Auto-fix lint/format issues | When lint errors exist |

üìñ **Command Details**: [.claude/README.md#-custom-slash-commands](./.claude/README.md#-custom-slash-commands)

## üî® Most-Used NPM Scripts

```bash
# Development
npm run type-check:watch   # Watch types in background
npm run serve:test         # Start test server (localhost:3000)

# Quality
npm run check              # Lint + format check
npm run fix                # Auto-fix lint/format
npm run test               # Run all tests
npm run test:coverage      # Generate coverage report

# Build
npm run build:all          # Build ESM + CJS + Browser bundles

# Release
npm run release:patch      # Patch version (0.11.0 ‚Üí 0.11.1)
npm run release:minor      # Minor version (0.11.0 ‚Üí 0.12.0)
```

---

# Code Style

## Architecture Patterns

### StateManager Pattern
All managers extend `StateManager` to access global state via `this.state`

### Handler Pattern
Event handlers **MUST** implement:
- `startTracking()` - Attach event listeners (use `{ passive: true }` for scroll/touch)
- `stopTracking()` - **MUST** remove all listeners to prevent memory leaks

### Memory Management (CRITICAL)
- **YOU MUST** remove event listeners in `stopTracking()`
- **YOU MUST** clear timers/intervals in `cleanup()` methods
- **YOU MUST** use `passive: true` for scroll/touch listeners
- **TIP**: Use `memory-leak-detector` agent when creating/modifying handlers

### Client-Only First
- Library works autonomously without backend
- Optional integrations: `tracelog` (SaaS) / `custom` (your API) / `googleAnalytics` (GA4)
- Events always emitted via `on('event')` regardless of backend config

## Naming Conventions

- **Handlers**: `*.handler.ts` - Event capture implementations
- **Managers**: `*.manager.ts` - Core business logic
- **Utils**: `*.utils.ts` - Pure functions (no side effects)
- **Types**: `*.types.ts` - TypeScript type definitions
- **Tests**: `*.test.ts` (unit/integration), `*.spec.ts` (E2E)

## Testing Guidelines

- **Unit Tests**: 90%+ coverage for core logic (handlers, managers, utils)
- **E2E Tests**: Use `window.__traceLogBridge` for internal state access
- **QA Mode**: Add `?tlog_mode=qa` to URL for verbose logging
- **CSP-Safe**: Use `page.evaluate()` NOT `page.waitForFunction()` in E2E tests
- **Queue Structure**: `sessionId` goes in `queue.session_id`, NOT in individual events

---

# Common Pitfalls (MUST AVOID)

**IMPORTANT**: These are the most common mistakes:

1. **Memory Leaks**: Forgetting `removeEventListener()` in `stopTracking()`
   - **FIX**: Use `memory-leak-detector` agent

2. **Circular Dependencies**: Importing `managers/` from handlers
   - **FIX**: Import `types/` only, never `managers/` in handlers

3. **State Mutation**: Mutating `this.state` directly
   - **FIX**: **NEVER** mutate state. Always use setters

4. **CSP Violations**: Using `page.waitForFunction()` in E2E tests
   - **FIX**: Use `page.evaluate()` instead (CSP-safe)

5. **Queue Structure**: Putting `sessionId` in individual events
   - **FIX**: `sessionId` goes in `queue.session_id`, **NOT** per-event

---

# Quick Reference

## Project Structure

```
src/
‚îú‚îÄ‚îÄ handlers/              # Event capture (click, scroll, page-view, etc.)
‚îú‚îÄ‚îÄ managers/              # Core logic (state, event, session, storage, sender, user)
‚îú‚îÄ‚îÄ integrations/          # Third-party (Google Analytics)
‚îú‚îÄ‚îÄ listeners/             # Low-level event listeners
‚îú‚îÄ‚îÄ utils/                 # Utilities (browser, data, network, security, validations)
‚îú‚îÄ‚îÄ types/                 # TypeScript definitions
‚îú‚îÄ‚îÄ constants/             # Configuration constants
‚îî‚îÄ‚îÄ public-api.ts          # Library entry point
```

## Key Files

- **Public API**: [src/public-api.ts](./src/public-api.ts)
- **Main App**: [src/app.ts](./src/app.ts)
- **Config**: [src/constants/config.constants.ts](./src/constants/config.constants.ts)

## Important Constants

- **Session Timeout**: 15 minutes
- **Queue Interval**: 10 seconds
- **Event Expiry**: 2 hours (localStorage)
- **Coverage Target**: 90%+

## Event Types

- `PAGE_VIEW` - Navigation tracking
- `CLICK` - User interactions
- `SCROLL` - Scroll depth/engagement
- `SESSION_START/END` - Session boundaries
- `CUSTOM` - Business-specific events
- `WEB_VITALS` - Performance metrics (LCP, CLS, INP, FCP, TTFB)
- `ERROR` - JavaScript errors
- `VIEWPORT_VISIBLE` - Element visibility tracking

## Quick Tips

1. **‚≠ê New Feature**: ALWAYS use `/new-feature [desc]` for 40-50% time savings
2. **Pre-Commit**: ALWAYS run `/precommit` before committing
3. **Pre-Merge**: ALWAYS run `/compare-branch main` before merging
4. **Memory Safety**: Use `memory-leak-detector` agent for handlers
5. **Hooks Auto-Run**: Understand what runs automatically (see Development Hooks above)

---

## External Links

- **GitHub**: https://github.com/nacorga/tracelog-lib
- **NPM**: https://www.npmjs.com/package/@tracelog/lib
- **CDN**: https://cdn.jsdelivr.net/npm/@tracelog/lib@latest/dist/browser/tracelog.js
- **Full Pipeline Docs**: [.claude/README.md](./.claude/README.md)
- **Platform Docs**: [Platform CLAUDE.md](../CLAUDE.md)

---

**Last Updated**: October 2025
**Version**: 0.11.0
**License**: MIT
